name: "wazuhl_DQN"
layer {
  name: "experience_replay_state"
  type: "MemoryData"
  top: "data"
  top: "redundant1"
  include {
    phase: TRAIN
  }
  memory_data_param 
  {
    batch_size: ${MINIBATCH_SIZE}
    channels: ${NUMBER_OF_FEATURES}
    height: 1
    width: 1
  }
}
layer {
  name: "experience_replay_action"
  type: "MemoryData"
  top: "data_action"
  top: "redundant2"
  include {
    phase: TRAIN
  }
  memory_data_param
  {
    batch_size: ${MINIBATCH_SIZE}
    channels: ${NUMBER_OF_ACTIONS}
    height: 1
    width: 1
  }
}
layer {
  name: "flatten"
  type: "Flatten"
  top: "flatten_data_action"
  bottom: "data_action"
  include {
    phase: TRAIN
  }
}
layer {
  name: "live_input_state"
  type: "MemoryData"
  top: "data"
  top: "redundant4"
  include {
    phase: TEST
  }
  memory_data_param 
  {
    batch_size: 1
    channels: ${NUMBER_OF_FEATURES}
    height: 1
    width: 1
  }
}
layer {
  name: "norm"
  type: "BatchNorm"
  bottom: "data"
  top: "norm_data"
}
layer {
  name: "ip1"
  type: "InnerProduct"
  bottom: "norm_data"
  top: "ip1"
  inner_product_param {
    num_output: ${HIDDEN_SIZE_1}
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
  }
}
layer {
  name: "relu1"
  type: "ReLU"
  bottom: "ip1"
  top: "relu1"
}
layer {
  name: "ip2"
  type: "InnerProduct"
  bottom: "relu1"
  top: "ip2"
  inner_product_param {
    num_output: ${HIDDEN_SIZE_2}
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
  }
}
layer {
  name: "relu2"
  type: "ReLU"
  bottom: "ip2"
  top: "relu2"
}
layer {
  name: "action_ip1"
  type: "InnerProduct"
  bottom: "relu2"
  top: "action_ip1"
  inner_product_param {
    num_output: ${ACTION_HIDDEN_SIZE}
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
  }
}
layer {
  name: "action_relu1"
  type: "ReLU"
  bottom: "action_ip1"
  top: "action_relu1"
}
layer {
  name: "action_ip2"
  type: "InnerProduct"
  bottom: "action_relu1"
  top: "action_ip2"
  inner_product_param {
    num_output: ${NUMBER_OF_ACTIONS}
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
  }
}
layer {
  name: "action_tanh"
  type: "TanH"
  bottom: "action_ip2"
  top: "action_tanh"
}
layer {
  name: "scale"
  type: "Power"
  bottom: "action_tanh"
  top: "action_scaled"
  power_param {
    power: 1
    scale: 20
    shift: 0
  }
}
layer {
  name: "action_bias"
  type: "Bias"
  bottom: "action_scaled"
  top: "A_advantage"
  bias_param {
    filler {
      type: "constant"
      value: 0
    }
  }
}
layer {
  name: "mean"
  type: "Reduction"
  bottom: "A_advantage"
  top: "mean_advantage"
  reduction_param {
    operation: MEAN
  }
}
layer {
  name: "negation"
  type: "Power"
  bottom: "mean_advantage"
  top: "negative_mean_advantage"
  power_param {
    power: 1
    scale: -1
    shift: 0
  }
}
layer {
  name: "delta"
  type: "Bias"
  bottom: "A_advantage"
  bottom: "negative_mean_advantage"
  top: "delta_advantage"
}
layer {
  name: "ip3"
  type: "InnerProduct"
  bottom: "relu2"
  top: "ip3"
  inner_product_param {
    num_output: 1
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
  }
}
layer {
  name: "tanh"
  type: "TanH"
  bottom: "ip3"
  top: "tanh"
}
layer {
  name: "scale"
  type: "Power"
  bottom: "tanh"
  top: "scaled"
  power_param {
    power: 1
    scale: 20
    shift: 0
  }
}
layer {
  name: "bias"
  type: "Bias"
  bottom: "scaled"
  top: "V_value"
  bias_param {
    filler {
      type: "constant"
      value: 0
    }
  }
}

layer {
  name: "tile"
  type: "Tile"
  bottom: "V_value"
  top: "V_values"
  tile_param {
    tiles: ${NUMBER_OF_ACTIONS}
  }
}
layer {
  name: "sum"
  type: "Eltwise"
  bottom: "delta_advantage"
  bottom: "V_values"
  top: "Q_values"
  eltwise_param {
    operation: SUM
  }
}

layer {
  name: "eltwise"
  type: "Eltwise"
  bottom: "Q_values"
  bottom: "flatten_data_action"
  top: "filtered_Q_values"
  eltwise_param {
    operation: PROD
  }
  include {
    phase: TRAIN
  }
}

layer {
  name: "experience_replay_value"
  type: "MemoryData"
  top: "experience_replay_value"
  top: "redundant3"
  include {
    phase: TRAIN
  }
  memory_data_param
  {
    batch_size: ${MINIBATCH_SIZE}
    channels: ${NUMBER_OF_ACTIONS}
    height: 1
    width: 1
  }
}
layer {
  name: "silence_train"
  type: "Silence"
  bottom: "redundant1"
  bottom: "redundant2"
  bottom: "redundant3"
  include {
    phase: TRAIN
  }
}
layer {
  name: "silence_test"
  type: "Silence"
  bottom: "redundant4"
  include {
    phase: TEST
  }
}
layer {
  name: "loss"
  type: "EuclideanLoss"
  bottom: "filtered_Q_values"
  bottom: "experience_replay_value"
  top: "loss"
  include {
    phase: TRAIN
  }
}
